name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

concurrency:
    group: ci-${{ github.event.pull_request.number || github.sha }}
    cancel-in-progress: true

permissions:
    contents: read
    pull-requests: write
    issues: write

env:
    CARGO_TERM_COLOR: always

jobs:
    changes:
        name: Detect Change Scope
        runs-on: ubuntu-latest
        outputs:
            docs_only: ${{ steps.scope.outputs.docs_only }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect docs-only changes
              id: scope
              shell: bash
              run: |
                  set -euo pipefail

                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    BASE="${{ github.event.pull_request.base.sha }}"
                  else
                    BASE="${{ github.event.before }}"
                  fi

                  if [ -z "$BASE" ] || ! git cat-file -e "$BASE^{commit}" 2>/dev/null; then
                    echo "docs_only=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  CHANGED="$(git diff --name-only "$BASE" HEAD || true)"
                  if [ -z "$CHANGED" ]; then
                    echo "docs_only=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  docs_only=true
                  while IFS= read -r file; do
                    [ -z "$file" ] && continue

                    if [[ "$file" == docs/* ]] \
                      || [[ "$file" == *.md ]] \
                      || [[ "$file" == *.mdx ]] \
                      || [[ "$file" == "LICENSE" ]] \
                      || [[ "$file" == .github/ISSUE_TEMPLATE/* ]] \
                      || [[ "$file" == .github/pull_request_template.md ]]; then
                      continue
                    fi

                    docs_only=false
                    break
                  done <<< "$CHANGED"

                  echo "docs_only=$docs_only" >> "$GITHUB_OUTPUT"

    lint:
        name: Format & Lint
        needs: [changes]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 20
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
                  components: rustfmt, clippy
            - uses: Swatinem/rust-cache@v2
            - name: Install script linters
              run: |
                  sudo apt-get update
                  sudo apt-get install -y shellcheck python3-pip
                  python3 -m pip install --upgrade pip
                  python3 -m pip install ruff
            - name: Run rustfmt
              run: cargo fmt --all -- --check
            - name: Run clippy
              run: cargo clippy --locked --all-targets -- -D warnings -A clippy::pedantic
            - name: Run shellcheck on scripts
              run: shellcheck scripts/benchmark_ci.sh scripts/refresh_benchmark_baseline.sh scripts/install.sh
            - name: Run ruff format check
              run: ruff format --check scripts/*.py

    test:
        name: Test
        needs: [changes]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
            - uses: Swatinem/rust-cache@v2
            - name: Run tests
              run: cargo test --locked --verbose

    build:
        name: Build (Smoke)
        needs: [changes]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 20

        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
            - uses: Swatinem/rust-cache@v2
            - name: Build release binary
              run: cargo build --release --locked --verbose

    benchmark:
        name: Performance & Cost Benchmarks
        needs: [changes, build]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 30
        env:
            CRABCLAW_BENCH_STRICT: '1'
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
            - uses: Swatinem/rust-cache@v2
            - name: Run benchmark gate
              run: bash scripts/benchmark_ci.sh
            - name: Append benchmark summary to job summary
              if: always()
              run: |
                  if [ -f benchmark/results/summary.md ]; then
                    cat benchmark/results/summary.md >> "$GITHUB_STEP_SUMMARY"
                  else
                    echo "## ⚠️ Benchmark summary unavailable" >> "$GITHUB_STEP_SUMMARY"
                  fi
            - name: Post benchmark summary to PR
              if: always() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const marker = '<!-- crabclaw-bench-summary -->';
                      const path = 'benchmark/results/summary.md';
                      let body = `${marker}\n## ⚠️ Benchmark summary unavailable`;
                      if (fs.existsSync(path)) {
                        body = `${marker}\n` + fs.readFileSync(path, 'utf8');
                      }

                      const { owner, repo } = context.repo;
                      const issue_number = context.payload.pull_request.number;

                      const comments = await github.paginate(github.rest.issues.listComments, {
                        owner,
                        repo,
                        issue_number,
                        per_page: 100,
                      });

                      const existing = comments.find(c => c.body && c.body.includes(marker));
                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner,
                          repo,
                          comment_id: existing.id,
                          body,
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner,
                          repo,
                          issue_number,
                          body,
                        });
                      }

            - name: Upload benchmark artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results
                  path: benchmark/results/

    benchmark-real:
        name: Real Provider/Channel/Tool Benchmarks (optional)
        needs: [changes, build]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 30
        env:
            CRABCLAW_BENCH_STRICT: '1'
            CRABCLAW_BENCH_MODE: real
            CRABCLAW_BENCH_BASELINE: benchmark/baseline.real.json
            CRABCLAW_BENCH_REAL_PROVIDER_URL: ${{ secrets.CRABCLAW_BENCH_REAL_PROVIDER_URL }}
            CRABCLAW_BENCH_REAL_PROVIDER_API_KEY: ${{ secrets.CRABCLAW_BENCH_REAL_PROVIDER_API_KEY }}
            CRABCLAW_BENCH_REAL_PROVIDER_MODEL: ${{ secrets.CRABCLAW_BENCH_REAL_PROVIDER_MODEL }}
            CRABCLAW_BENCH_REAL_CHANNEL_WEBHOOK_URL: ${{ secrets.CRABCLAW_BENCH_REAL_CHANNEL_WEBHOOK_URL }}
            CRABCLAW_BENCH_REAL_TOOL_COMMAND: ${{ secrets.CRABCLAW_BENCH_REAL_TOOL_COMMAND }}
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
            - uses: Swatinem/rust-cache@v2
            - name: Check real benchmark prerequisites
              id: real_bench
              shell: bash
              run: |
                  if [ -n "${CRABCLAW_BENCH_REAL_PROVIDER_URL:-}" ]; then
                    echo "enabled=true" >> "$GITHUB_OUTPUT"
                    echo "Real benchmark prerequisites present."
                  else
                    echo "enabled=false" >> "$GITHUB_OUTPUT"
                    echo "Real benchmark secrets missing; skipping optional real benchmark run."
                  fi
            - name: Run optional real benchmark suite
              if: steps.real_bench.outputs.enabled == 'true'
              run: bash scripts/benchmark_ci.sh
            - name: Append real benchmark summary to job summary
              if: always()
              run: |
                  if [ -f benchmark/results/summary.md ]; then
                    cat benchmark/results/summary.md >> "$GITHUB_STEP_SUMMARY"
                  else
                    echo "## ⚠️ Real benchmark summary unavailable" >> "$GITHUB_STEP_SUMMARY"
                  fi
            - name: Upload real benchmark artifacts
              if: always() && steps.real_bench.outputs.enabled == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results-real
                  path: benchmark/results/

    docs-only:
        name: Docs-Only Fast Path
        needs: [changes]
        if: needs.changes.outputs.docs_only == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Skip heavy jobs for docs-only change
              run: echo "Docs-only change detected. Rust lint/test/build skipped."

    ci-required:
        name: CI Required Gate
        if: always()
        needs: [changes, lint, test, build, benchmark, docs-only]
        runs-on: ubuntu-latest
        steps:
            - name: Enforce required status
              shell: bash
              run: |
                  set -euo pipefail

                  if [ "${{ needs.changes.outputs.docs_only }}" = "true" ]; then
                    echo "Docs-only fast path passed."
                    exit 0
                  fi

                  lint_result="${{ needs.lint.result }}"
                  test_result="${{ needs.test.result }}"
                  build_result="${{ needs.build.result }}"
                  benchmark_result="${{ needs.benchmark.result }}"

                  echo "lint=${lint_result}"
                  echo "test=${test_result}"
                  echo "build=${build_result}"
                  echo "benchmark=${benchmark_result}"

                  if [ "$lint_result" != "success" ] || [ "$test_result" != "success" ] || [ "$build_result" != "success" ] || [ "$benchmark_result" != "success" ]; then
                    echo "Required CI jobs did not pass."
                    exit 1
                  fi

                  echo "All required CI jobs passed."
